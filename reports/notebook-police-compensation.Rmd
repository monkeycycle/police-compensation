```{r config, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# Run config first to use dynamic variables in the YAML
if (!require("upstartr")) install.packages("upstartr")
library("upstartr")
run_config()
```

---
title: "`r getOption("startr.title")`"
author: "`r getOption("startr.author")`"
date: "`r format(Sys.Date(), "%B %d, %Y")`"
output:
  html_document:
    toc: true
    number_sections: true    
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false    
    highlight: textmate
    theme: cosmo
    df_print: kable
    self_contained: true
    code_folding: hide
---

```{r get_read_data, echo=FALSE, message=FALSE, warning=FALSE, fold_source=TRUE}

run_process()
run_analyze()
run_visualize()

```


* WPS is encoded as both `Police Service` and `Police Services`. 
  * TODO: Normalize department names
* Some entries are salaries below $70,000
* TODO: Confirm if OT is included across all years


```{r summarize_winnipeg_police, echo=FALSE, message=FALSE, warning=FALSE, fold_source=TRUE}

winnipeg_all_salary_disclosure_2016_2020__dept_cnt <- winnipeg_all_salary_disclosure_2016_2020 %>%   group_by(year, department) %>% 
  count(department) %>% 
  rename(
    count = n
  )

winnipeg_all_salary_disclosure_2016_2020__dept_sum <- winnipeg_all_salary_disclosure_2016_2020 %>%   
  group_by(year, department) %>% 
  summarise(
    sum_compensation = sum(compensation, na.rm = TRUE), 
    mean_compensation = mean(compensation, na.rm = TRUE),
    median_compensation = median(compensation, na.rm = TRUE),
    max_compensation = max(compensation, na.rm = TRUE)
  ) 

winnipeg_all_salary_disclosure_2016_2020_grouped <- left_join(
  winnipeg_all_salary_disclosure_2016_2020__dept_cnt,
  winnipeg_all_salary_disclosure_2016_2020__dept_sum,
  ) %>% 
  ungroup()

winnipeg_all_salary_disclosure_2016_2020_grouped_ranked <- winnipeg_all_salary_disclosure_2016_2020_grouped %>% 
  group_by(year) %>% 
  mutate(
    rank_count = order(order(count, decreasing=TRUE)),
    rank_sum_compensation = order(order(sum_compensation, decreasing=TRUE)),
    rank_mean_compensation = order(order(mean_compensation, decreasing=TRUE)),
    rank_median_compensation = order(order(median_compensation, decreasing=TRUE)),
    rank_max_compensation = order(order(max_compensation, decreasing=TRUE))
  ) %>% 
  select(
    -count,
    -sum_compensation,
    -mean_compensation,
    -median_compensation,
    -max_compensation
  )

```




### Data tables

####  winnipeg_all_salary_disclosure_2016_2020_grouped_ranked
```{r dt_winnipeg_all_salary_disclosure_2016_2020_grouped_ranked, echo=TRUE, message=TRUE, warning=TRUE }

datatable(winnipeg_all_salary_disclosure_2016_2020_grouped_ranked,
          caption = 'Table: winnipeg_all_salary_disclosure_2016_2020_grouped_ranked',
          class="cell-border stripe", 
          rownames=FALSE,
          filter = 'top',
          options = list(
            pageLength = 10,
            order = list(list(1, 'desc'))
          )
        )
```

####  winnipeg_all_salary_disclosure_2016_2020_grouped
```{r dt_winnipeg_all_salary_disclosure_2016_2020_grouped, echo=TRUE, message=TRUE, warning=TRUE }

datatable(winnipeg_all_salary_disclosure_2016_2020_grouped,
          caption = 'Table: winnipeg_all_salary_disclosure_2016_2020_grouped',
          class="cell-border stripe", 
          rownames=FALSE,
          filter = 'top',
          options = list(
            pageLength = 10,
            order = list(list(1, 'desc'))
          )
        )
```

----

#### winnipeg_police_salary_disclosure_2016_2020

Winnipeg Police Service staff are named but officers (Constables, etc.) are not.

```{r dt_winnipeg_police_salary_disclosure_2016_2020, echo=TRUE, message=TRUE, warning=TRUE }

datatable(winnipeg_police_salary_disclosure_2016_2020,
          caption = 'Table: winnipeg_police_salary_disclosure_2016_2020',
          class="cell-border stripe", 
          rownames=FALSE,
          filter = 'top',
          options = list(
            pageLength = 25,
            order = list(list(1, 'desc'))
          )
        )

```
